<%- include('partials/header') %>

    <main class="container mt-40">
        <a href="/shop" class="btn btn-secondary mb-20">Go Back</a>

        <div class="product-details-grid">
            <div class="card product-image-card">
                <img src="<%= product.image %>" alt="<%= product.name %>" class="img-responsive">
            </div>

            <div>
                <h1 class="product-title-large">
                    <%= product.name %>
                </h1>
                <p class="text-muted" style="margin-bottom: 10px;">
                    Added by <%= product.user ? product.user.name : 'Unknown' %>
                </p>
                <div class="rating-container">
                    <div class="rating text-warning">
                        <% for(let i=0; i < 5; i++) { %>
                            <% if (product.rating>= i + 1) { %>
                                <i class="fas fa-star"></i>
                                <% } else if (product.rating>= i + 0.5) { %>
                                    <i class="fas fa-star-half-alt"></i>
                                    <% } else { %>
                                        <i class="far fa-star"></i>
                                        <% } %>
                                            <% } %>
                    </div>
                    <span class="text-muted">
                        <%= product.numReviews %> reviews
                    </span>
                </div>

                <div class="card mb-20">
                    <div class="product-meta-row">
                        <span>Price:</span>
                        <% if (product.discount> 0) { %>
                            <div>
                                <span style="text-decoration: line-through; color: #888; margin-right: 10px;">€<%=
                                        product.price %></span>
                                <strong class="text-lg" style="color: var(--danger-color);">€<%= product.discountedPrice
                                        %></strong>
                                <span class="badge badge-danger" style="margin-left: 10px;">-<%= product.discount %>
                                        %</span>
                            </div>
                            <% } else { %>
                                <strong class="text-lg">€<%= product.price %></strong>
                                <% } %>
                    </div>
                    <div class="product-meta-row">
                        <span>Status:</span>
                        <span class="<%= product.countInStock > 0 ? 'text-success' : 'text-danger' %>">
                            <%= product.countInStock> 0 ? 'In Stock' : 'Out of Stock' %>
                        </span>
                    </div>

                    <% if (product.countInStock> 0) { %>
                        <div class="product-meta-row align-center mb-20">
                            <span>Qty:</span>
                            <select id="qty" class="form-select">
                                <% for(let x=1; x <=Math.min(product.countInStock, 10); x++) { %>
                                    <option value="<%= x %>">
                                        <%= x %>
                                    </option>
                                    <% } %>
                            </select>
                        </div>
                        <% } %>

                            <button data-id="<%= product._id %>" class="btn btn-primary btn-block btn-add-cart"
                                <%=product.countInStock===0 ? 'disabled' : '' %>>
                                <%= product.countInStock> 0 ? 'Add to Cart' : 'Out of Stock' %>
                            </button>

                            <button id="add-wishlist-btn" class="btn btn-secondary btn-block mt-10">
                                <i class="far fa-heart"></i> Add to Wishlist
                            </button>
                </div>

                <p class="product-description">
                    <%= product.description %>
                </p>

                <!-- Reviews Section -->
                <div class="reviews-section mt-40">
                    <h2 class="mb-20">Reviews (<%= totalReviews %>)</h2>

                    <% if (reviews.length===0) { %>
                        <div class="alert alert-info">No reviews yet. Be the first to review!</div>
                        <% } else { %>
                            <div class="review-list mb-30">
                                <% reviews.forEach(review=> { %>
                                    <div class="card mb-10" style="padding: 15px; position: relative;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <strong>
                                                <%= review.name %>
                                            </strong>
                                            <div class="rating text-warning" style="font-size: 0.8rem;">
                                                <% for(let i=0; i < 5; i++) { %>
                                                    <% if (review.rating>= i + 1) { %>
                                                        <i class="fas fa-star"></i>
                                                        <% } else if (review.rating>= i + 0.5) { %>
                                                            <i class="fas fa-star-half-alt"></i>
                                                            <% } else { %>
                                                                <i class="far fa-star"></i>
                                                                <% } %>
                                                                    <% } %>
                                            </div>
                                        </div>
                                        <p style="margin: 0; color: var(--text-color);">
                                            <%= review.comment %>
                                        </p>
                                        <small class="text-muted">
                                            <%= new Date(review.createdAt).toLocaleDateString() %>
                                        </small>

                                        <!-- Delete Review Button (Hidden by default) -->
                                        <button class="btn-delete-review" data-id="<%= review._id %>"
                                            data-user-id="<%= review.user %>"
                                            style="display: none; position: absolute; bottom: 10px; right: 10px; background: none; border: none; color: var(--danger-color); cursor: pointer;">
                                            <i class="fas fa-trash"></i> Delete Review
                                        </button>
                                    </div>
                                    <% }) %>
                            </div>

                            <!-- Pagination -->
                            <% if (totalPages> 1) { %>
                                <div class="pagination"
                                    style="display: flex; justify-content: center; gap: 10px; margin-bottom: 30px;">
                                    <% if (currentPage> 1) { %>
                                        <a href="/product/<%= product._id %>?page=<%= currentPage - 1 %>"
                                            class="btn btn-secondary">Previous</a>
                                        <% } %>

                                            <% for(let i=1; i <=totalPages; i++) { %>
                                                <a href="/product/<%= product._id %>?page=<%= i %>"
                                                    class="btn <%= i === currentPage ? 'btn-primary' : 'btn-secondary' %>">
                                                    <%= i %>
                                                </a>
                                                <% } %>

                                                    <% if (currentPage < totalPages) { %>
                                                        <a href="/product/<%= product._id %>?page=<%= currentPage + 1 %>"
                                                            class="btn btn-secondary">Next</a>
                                                        <% } %>
                                </div>
                                <% } %>
                                    <% } %>

                                        <div class="card" style="padding: 20px;">
                                            <h3 class="mb-20">Write a Customer Review</h3>
                                            <form id="review-form">
                                                <div class="form-group">
                                                    <label for="rating">Rating</label>
                                                    <select id="rating" class="form-select" required>
                                                        <option value="">Select...</option>
                                                        <option value="1">1 - Poor</option>
                                                        <option value="2">2 - Fair</option>
                                                        <option value="3">3 - Good</option>
                                                        <option value="4">4 - Very Good</option>
                                                        <option value="5">5 - Excellent</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="comment">Comment</label>
                                                    <textarea id="comment" class="form-input" rows="3"
                                                        required></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Submit Review</button>
                                            </form>
                                            <p id="login-message" class="mt-10 text-muted" style="display: none;">
                                                Please <a href="/login">sign in</a> to write a review.
                                            </p>
                                        </div>
                </div>

                <!-- Admin Actions -->
                <div id="admin-actions" class="admin-actions">

                    <div style="display: flex; gap: 10px;">
                        <button id="edit-product-btn" class="btn btn-primary">Edit Product</button>
                        <button id="delete-product-btn" data-id="<%= product._id %>" class="btn btn-danger">Delete
                            Product</button>
                    </div>

                    <!-- Edit Product Form (Hidden by default) -->
                    <div id="edit-product-container" class="card mt-20" style="display: none; padding: 24px;">
                        <h3 class="mb-20">Edit Product</h3>
                        <form id="edit-product-form">
                            <div class="form-group">
                                <label for="p-name" class="form-label">Product Name</label>
                                <input type="text" id="p-name" class="form-input" value="<%= product.name %>" required>
                            </div>
                            <div class="form-group">
                                <label for="p-price" class="form-label">Price</label>
                                <input type="number" id="p-price" class="form-input" step="0.01"
                                    value="<%= product.price %>" required>
                            </div>
                            <div class="form-group">
                                <label for="p-image" class="form-label">Product Image</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="p-image" class="form-input" value="<%= product.image %>"
                                        readonly style="background: var(--background-color); color: var(--text-muted);">
                                    <label for="p-image-file" class="btn btn-secondary"
                                        style="cursor: pointer; white-space: nowrap;">
                                        <i class="fas fa-upload"></i> Upload
                                    </label>
                                    <input type="file" id="p-image-file" style="display: none;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="p-brand" class="form-label">Brand</label>
                                <input type="text" id="p-brand" class="form-input" value="<%= product.brand %>"
                                    required>
                            </div>
                            <div class="form-group">
                                <label for="p-category" class="form-label">Category</label>
                                <input type="text" id="p-category" class="form-input" value="<%= product.category %>"
                                    list="category-list" required>
                                <datalist id="category-list"></datalist>
                            </div>
                            <div class="form-group">
                                <label for="p-countInStock" class="form-label">Count In
                                    Stock</label>
                                <input type="number" id="p-countInStock" class="form-input"
                                    value="<%= product.countInStock %>" required>
                            </div>
                            <div class="form-group">
                                <label for="p-discount" class="form-label">Discount (%)</label>
                                <input type="number" id="p-discount" class="form-input" min="0" max="100"
                                    value="<%= product.discount || 0 %>">
                            </div>
                            <div class="form-group">
                                <label for="p-description" class="form-label">Description</label>
                                <textarea id="p-description" class="form-input" rows="4"
                                    required><%= product.description %></textarea>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">Update
                                    Product</button>
                                <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <%- include('partials/confirm-modal') %>
        <script src="/js/modal-utils.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Check permissions and show admin actions
                const user = getUser(); // From main.js
                const productUserId = '<%= product.user._id %>';

                if (user && (user.isAdmin || user._id === productUserId)) {
                    const adminActions = document.getElementById('admin-actions');
                    if (adminActions) {
                        adminActions.style.display = 'block';
                        fetchCategories();
                    }
                }

                async function fetchCategories() {
                    try {
                        const res = await fetch('/api/products/categories');
                        const categories = await res.json();
                        const dataList = document.getElementById('category-list');
                        if (dataList) {
                            dataList.innerHTML = categories.map(c => `<option value="${c}">`).join('');
                        }
                    } catch (error) {
                        console.error('Error fetching categories:', error);
                    }
                }

                // Handle Delete Product Button
                const deleteBtn = document.getElementById('delete-product-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        showConfirmModal('Delete Product', 'Are you sure you want to delete this product? This action cannot be undone.', async () => {
                            const user = getUser();
                            if (!user) {
                                window.location.href = '/login';
                                return;
                            }

                            const productId = deleteBtn.dataset.id;

                            try {
                                const res = await fetch(`/api/products/${productId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${user.token}`
                                    }
                                });

                                if (res.ok) {
                                    showToast('Product deleted successfully', 'success');
                                    setTimeout(() => window.location.href = '/shop', 1000);
                                } else {
                                    const data = await res.json();
                                    showToast(data.message || 'Failed to delete product', 'danger');
                                }
                            } catch (error) {
                                console.error(error);
                                showToast('Error deleting product', 'danger');
                            }
                        });
                    });
                }

                // Handle Edit Button
                const editBtn = document.getElementById('edit-product-btn');
                const editContainer = document.getElementById('edit-product-container');
                const cancelEditBtn = document.getElementById('cancel-edit-btn');
                const editForm = document.getElementById('edit-product-form');

                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        editContainer.style.display = 'block';
                        editBtn.style.display = 'none';
                        // Scroll to form
                        editContainer.scrollIntoView({ behavior: 'smooth' });
                    });
                }

                if (cancelEditBtn) {
                    cancelEditBtn.addEventListener('click', () => {
                        editContainer.style.display = 'none';
                        editBtn.style.display = 'inline-flex';
                    });
                }

                // Handle Image Upload
                const imageFile = document.getElementById('p-image-file');
                if (imageFile) {
                    imageFile.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        const formData = new FormData();
                        formData.append('image', file);

                        try {
                            const res = await fetch('/api/upload', {
                                method: 'POST',
                                body: formData
                            });
                            const data = await res.text();
                            document.getElementById('p-image').value = data;
                        } catch (error) {
                            console.error(error);
                            showToast('Image upload failed', 'danger');
                        }
                    });
                }

                // Handle Form Submission
                if (editForm) {
                    editForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const user = getUser();
                        if (!user) return;

                        const productId = '<%= product._id %>';
                        const productData = {
                            name: document.getElementById('p-name').value,
                            price: document.getElementById('p-price').value,
                            image: document.getElementById('p-image').value,
                            brand: document.getElementById('p-brand').value,
                            category: document.getElementById('p-category').value,
                            countInStock: document.getElementById('p-countInStock').value,
                            discount: document.getElementById('p-discount').value,
                            description: document.getElementById('p-description').value,
                        };

                        try {
                            const res = await fetch(`/api/products/${productId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${user.token}`
                                },
                                body: JSON.stringify(productData)
                            });

                            if (res.ok) {
                                showToast('Product updated successfully', 'success');
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                showToast('Failed to update product', 'danger');
                            }
                        } catch (error) {
                            console.error(error);
                            showToast('Error updating product', 'danger');
                        }
                    });
                }

                // Review Delete Logic
                const deleteReviewBtns = document.querySelectorAll('.btn-delete-review');

                if (deleteReviewBtns.length > 0) {
                    const user = getUser();

                    if (user) {
                        deleteReviewBtns.forEach(btn => {
                            const reviewOwnerId = btn.dataset.userId;

                            // Show if Admin OR Owner
                            if (user.isAdmin || user._id === reviewOwnerId) {
                                btn.style.display = 'block';

                                btn.addEventListener('click', () => {
                                    const reviewId = btn.dataset.id;
                                    showConfirmModal('Delete Review', 'Are you sure you want to delete this review?', async () => {
                                        const productId = '<%= product._id %>';

                                        try {
                                            const res = await fetch(`/api/products/${productId}/reviews/${reviewId}`, {
                                                method: 'DELETE',
                                                headers: {
                                                    'Authorization': `Bearer ${user.token}`
                                                }
                                            });

                                            if (res.ok) {
                                                showToast('Review deleted', 'success');
                                                setTimeout(() => location.reload(), 300);
                                            } else {
                                                const data = await res.json();
                                                showToast(data.message || 'Failed to delete review', 'danger');
                                            }
                                        } catch (error) {
                                            console.error(error);
                                            showToast('Error deleting review', 'danger');
                                        }
                                    });
                                });
                            }
                        });
                    }
                }

                // Review Form Logic
                const reviewForm = document.getElementById('review-form');
                const loginMessage = document.getElementById('login-message');

                if (reviewForm) {
                    const user = getUser();
                    if (!user) {
                        reviewForm.style.display = 'none';
                        loginMessage.style.display = 'block';
                    } else {
                        reviewForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const rating = document.getElementById('rating').value;
                            const comment = document.getElementById('comment').value;
                            const productId = '<%= product._id %>';

                            try {
                                const res = await fetch(`/api/products/${productId}/reviews`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${user.token}`
                                    },
                                    body: JSON.stringify({ rating, comment })
                                });

                                const data = await res.json();

                                if (res.ok) {
                                    showToast('Review submitted successfully', 'success');
                                    setTimeout(() => location.reload(), 1000);
                                } else {
                                    showToast(data.message || 'Failed to submit review', 'danger');
                                }
                            } catch (error) {
                                console.error(error);
                                showToast('Error submitting review', 'danger');
                            }
                        });
                    }
                }

                // Wishlist Logic
                // Wishlist Logic
                const wishlistBtn = document.getElementById('add-wishlist-btn');
                if (wishlistBtn) {
                    const user = getUser();
                    const productUserId = '<%= product.user._id %>';
                    const productId = '<%= product._id %>';

                    // 1. Check if user is owner
                    if (user && user._id === productUserId) {
                        wishlistBtn.style.display = 'none';
                    } else if (user) {
                        // 2. Check if in wishlist
                        checkWishlistStatus();
                    }

                    async function checkWishlistStatus() {
                        try {
                            const res = await fetch('/api/wishlist', {
                                headers: {
                                    'Authorization': `Bearer ${user.token}`
                                }
                            });
                            const wishlist = await res.json();
                            const isInWishlist = wishlist.some(item => item._id === productId);

                            updateWishlistButton(isInWishlist);
                        } catch (error) {
                            console.error('Error checking wishlist:', error);
                        }
                    }

                    function updateWishlistButton(isInWishlist) {
                        if (isInWishlist) {
                            wishlistBtn.innerHTML = '<i class="fas fa-heart-broken"></i> Remove from Wishlist';
                            wishlistBtn.classList.remove('btn-secondary');
                            wishlistBtn.classList.add('btn-danger');
                            wishlistBtn.dataset.action = 'remove';
                        } else {
                            wishlistBtn.innerHTML = '<i class="far fa-heart"></i> Add to Wishlist';
                            wishlistBtn.classList.remove('btn-danger');
                            wishlistBtn.classList.add('btn-secondary');
                            wishlistBtn.dataset.action = 'add';
                        }
                        wishlistBtn.disabled = false;
                    }

                    wishlistBtn.addEventListener('click', async () => {
                        if (!user) {
                            window.location.href = '/login';
                            return;
                        }

                        const action = wishlistBtn.dataset.action;
                        wishlistBtn.disabled = true;

                        try {
                            let res;
                            if (action === 'remove') {
                                res = await fetch(`/api/wishlist/${productId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${user.token}`
                                    }
                                });
                            } else {
                                res = await fetch('/api/wishlist', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${user.token}`
                                    },
                                    body: JSON.stringify({ productId })
                                });
                            }

                            if (res.ok) {
                                const isNowInWishlist = action === 'add';
                                updateWishlistButton(isNowInWishlist);
                                showToast(isNowInWishlist ? 'Added to wishlist' : 'Removed from wishlist', 'success');
                            } else {
                                const data = await res.json();
                                showToast(data.message || 'Action failed', 'danger');
                                wishlistBtn.disabled = false;
                            }
                        } catch (error) {
                            console.error(error);
                            showToast('Error updating wishlist', 'danger');
                            wishlistBtn.disabled = false;
                        }
                    });
                }
            });
        </script>

        <%- include('partials/footer') %>